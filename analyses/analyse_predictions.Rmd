---
title: "Analyse_Predictions"
author: "Jo Fisher"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

library(ggplot2)
library(dplyr)
library(scales)                                        
library(tidyr)
library(dplyr)
library(Hmisc)
library(ggridges)
library(ggbeeswarm)
library(ggtext)
library(reshape2)
library(readr)
library(ggpubr)
library(ggchicklet)
library(Seurat)
library(ggrastr)
library(stringr)
library(RColorBrewer)
library(ggrepel)
library(showtext)
library(cowplot)
library(colorspace)
library(future)
library(grid)
library(gridExtra) 

#set colors
method_cols <- c(BABEL  ="#F79BB2", sciPENN="#e6173a", cTP_net= "#EB7926FF", totalVI= "#FFBB44FF", scMMT= "#859B6CFF", SPECK= "#4FD3DA", scLinear= "#006B62", Seurat = "black" )
method_cols[1:length(method_cols)] <- lighten(method_cols, 0.3)
ct_cols <- method_cols
names(ct_cols) <- c('All','B','CD4 T','CD8 T','DC','Mono','NK')

#adjust geyser palette
geyser_adjust <- c(paletteer::paletteer_d('rcartocolor::Geyser')[c(1,2)], 'white',paletteer::paletteer_d('rcartocolor::Geyser')[c(6,7)])
geyser_adjust <- colorRampPalette(geyser_adjust)(7)

#location where pipeline outcomes are saved
savedir <- '~/workspace/analyses/protein_prediction_publication/'
#location to write figures to
outdir <- '~/workspace/analyses/protein_prediction_publication/analyses/results/'

#get benchmarking results
predfiles <- list.files( paste0(savedir,'benchmarking'))
benchmark_predset <- list()
for(i in c(1,0.5,0.25,0.125,0.0625)){
  file <- predfiles[grep(paste0('^',i), predfiles)]
  load(paste0( savedir,'benchmarking/',file ) )
  
  
  benchmark_predset[[as.character(i)]][['cor']] <- corrList
  benchmark_predset[[as.character(i)]][['RMSE']] <-RMSEList
  benchmark_predset[[as.character(i)]][['pred']] <-predList
}

leave_out_predset <- list()
for(i in c('_B','_CD4 T' , '_CD8 T', '_DC','_Mono','_NK')){
  file <- predfiles[grep(paste0('^',i), predfiles)]
  load(paste0( savedir,'benchmarking/',file ) )
  
  
  leave_out_predset[[as.character(i)]][['cor']] <- corrList
  leave_out_predset[[as.character(i)]][['RMSE']] <-RMSEList
  leave_out_predset[[as.character(i)]][['pred']] <-predList
}

one_only_predset <- list()
for(i in c('B','CD4 T' , 'CD8 T', 'DC','Mono','NK')){
  file <- predfiles[grep(paste0('^',i), predfiles)]
  load(paste0( savedir,'benchmarking/',file ) )
  
  
  one_only_predset[[as.character(i)]][['cor']] <- corrList
  one_only_predset[[as.character(i)]][['RMSE']] <-RMSEList
  one_only_predset[[as.character(i)]][['pred']] <-predList
}


#load dataset objects

ref <- read.csv(paste0(savedir,'repo/source_data/celltype_map.csv'))

#relabel test sets
Hao_test <- load(paste0(savedir,'repo/source_data/Hao_etal_comparison_test.Rdata')) %>% get()
Leader_test <- load(paste0(savedir,'repo/source_data/Leader_etal_comparison_test.Rdata')) %>% get()
Steph_Healthy_test <- load(paste0(savedir,'repo/source_data/Stephenson_etal_Healthy_comparison_test.Rdata')) %>% get()
Steph_Covid_test <- load(paste0(savedir,'repo/source_data/Stephenson_etal_Covid_comparison_test.Rdata')) %>% get()
Zhang_test<- load(paste0(savedir,'repo/source_data/Zhang_etal_comparison_test.Rdata')) %>% get()

ind <- match(Hao_test$celltype, ref$celltype)
Hao_test$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Leader_test$celltype_detailed, ref$celltype)
Leader_test$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Steph_Healthy_test$celltype, ref$celltype)
Steph_Healthy_test$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Steph_Covid_test$celltype, ref$celltype)
Steph_Covid_test$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Zhang_test$cluster_name, ref$celltype)
Zhang_test$unified_celltype <- ref$unified_celltype[ind]

#relabel test sets
Hao_train <- load(paste0(savedir,'repo/source_data/Hao_etal_comparison_train.Rdata')) %>% get()
Leader_train <- load(paste0(savedir,'repo/source_data/Leader_etal_comparison_train.Rdata')) %>% get()
Steph_Healthy_train <- load(paste0(savedir,'repo/source_data/Stephenson_etal_Healthy_comparison_train.Rdata')) %>% get()
Steph_Covid_train <- load(paste0(savedir,'repo/source_data/Stephenson_etal_Covid_comparison_train.Rdata')) %>% get()
Zhang_train<- load(paste0(savedir,'repo/source_data/Zhang_etal_comparison_train.Rdata')) %>% get()

ind <- match(Hao_train$celltype, ref$celltype)
Hao_train$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Leader_train$celltype_detailed, ref$celltype)
Leader_train$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Steph_Healthy_train$celltype, ref$celltype)
Steph_Healthy_train$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Steph_Covid_train$celltype, ref$celltype)
Steph_Covid_train$unified_celltype <- ref$unified_celltype[ind]
ind <- match(Zhang_train$cluster_name, ref$celltype)
Zhang_train$unified_celltype <- ref$unified_celltype[ind]



testobjs <- list('Hao_etal'=Hao_test, 'Leader_etal'=Leader_test,'Stephenson_etal_Healthy'=Steph_Healthy_test, 'Stephenson_etal_Covid'=Steph_Covid_test, 'Zhang_etal'=Zhang_test)
trainobjs <- list('Hao_etal'=Hao_train, 'Leader_etal'=Leader_train,'Stephenson_etal_Healthy'=Steph_Healthy_train, 'Stephenson_etal_Covid'=Steph_Covid_train, 'Zhang_etal'=Zhang_train)
```









# FIG1: Hao Data Presentation

## FIG 1A

```{r, format seurat objects}
#add predictions to seurat object
obj <- load(paste0(savedir,'repo/source_data/Hao_et_al_Seurat_obj.Rdata')) %>% get()
rm(reference)
gc()

testobj <- subset(obj, cells = colnames(benchmark_predset[['1']]$pred$Seurat))
#plot Hao et al data for reference
cols <- method_cols[-length(method_cols)]

p <- DimPlot(obj, group.by='celltype',repel=T, label=T, raster=F) +
scale_color_manual(values = sample(alpha(colorRampPalette(cols)(length(unique(obj$celltype))),0.2)) )+
  ggtitle('')+
  theme(legend.position='none',
        text = element_text(size =10))

ggsave(p, file=paste0(outdir,'/Hao_umap.png'), width=5, height=5)
```


## FIG 1B

```{r}

cols <- RColorBrewer::brewer.pal(name='YlGnBu',n=9)
cols <- colorRampPalette(cols)(100) %>% rev()

dat <- FetchData(obj, c('CD103-Ab','ITGAE'))
coords <- obj@reductions$umap@cell.embeddings
df <- cbind(dat, coords)
df <- df[order(df$`protein_CD103-Ab`),]

p1 <- ggplot(df, aes(x = UMAP_1,y=UMAP_2, color=`protein_CD103-Ab`))+
  geom_point()+
  scale_color_gradientn(colors=cols, name='')+
  theme_minimal()+ xlab('')+ylab('')+
  ggtitle('CD103 (protein)')


df <- df[order(df$ITGAE),]
p2 <- ggplot(df, aes(x = UMAP_1,y=UMAP_2, color=ITGAE))+
  geom_point()+
  scale_color_gradientn(colors=cols, name='')+
  theme_minimal()+ xlab('')+ylab('')+
  ggtitle('ITGAE (RNA)')

p <- plot_grid(p1,p2)

ggsave(p, file = paste0(outdir,'CD103_UMAP.png'), height=8, width=16)

```

## SUPP FIG 1: raw correlation barplot

```{r, RNA vs. protein in Hao et al}

ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))

ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]
DefaultAssay(testobj) <-'protein'
protdf <- FetchData(testobj, ref$protein)
DefaultAssay(testobj) <-'RNA'
genedf <- FetchData(testobj, ref$gene)
genedf <- genedf[,ref$gene]
cmat <- cor(protdf, genedf)
cvals <- diag(cmat)
names(cvals) <- rownames(cmat)


#plot
df <- data.frame(features  = names(cvals), correlation = cvals)
df <- melt(df)
df$gene <- ref$gene[match(df$features, ref$protein)]
df$features<-factor(df$features, levels= rev(df$features[order(df$value)]))
df <-  df[match(levels(df$features), df$features),]
#what fraction of receptors have correlation < 0.5?


cols <- geyser_adjust

#split barplot into two rows
df$set <- 1
df$set[floor(dim(df)[1]/2) : dim(df)[1] ] <- 2


#plot barplot of correlation
p<-ggplot(df, aes(x=features, y=value, fill=value))+
  geom_chicklet(color = '#cccccc')+
  scale_fill_gradientn(colors=colorRampPalette(rev(cols))(100), limits=c(-1,1), guide = 'none')+
  theme_minimal()+
  xlab('')+
  ylab('cor.')+
  facet_wrap(vars(set), scale='free_x', ncol = 1)+
    theme(axis.text.x = element_text(size=9,  vjust=0.5, hjust=1, angle=90),
         text = element_text(size = 16),
         strip.background = element_blank(),
         strip.text.x = element_blank(),
          panel.grid.minor = element_blank())

ggsave(p, file=paste0(outdir,'/Hao_corr_barplot.png'), width=16.5, height=6)


```

## Fig1C RNA proxy measures

### raw correlation with RNA expression

```{r}

#plot individual prot vs RNA examples
feat <- ref$protein


plotList <- list()
corVals <- list()
for(f in feat){
  protname <- str_split(f,'-')[[1]][1]
  prot <-protdf[,f]
  gene <- genedf[,ref$gene[match(f, ref$protein)]]
  df <- data.frame(prot, gene)
  colnames(df) <- c('protein','RNA')
  corval <- cor(df$protein, df$RNA)
  p <- ggplot(df, aes(y=protein, x=RNA))+
    geom_point(size=2.4, color = 'black', alpha=0.35, shape=21, fill=col )+
   geom_smooth(method = "lm", color='black', linewidth=0.5)+
    stat_cor(aes(label = after_stat(r.label)), size=6)+
    xlab(paste0(protname,' (RNA)'))+
    ylab(paste0(protname,' (protein)'))+
    theme_minimal()+
    ggtitle(f)+
    theme(plot.title = element_text(size=20),
    axis.title.x = element_text(size=15),
    axis.title.y = element_text(size=15))
  
  plotList[[f]] <- p
  corVals[[f]] <- corval

}

vs_expr <- plotList


corVals <- unlist(corVals) 
varVals <- apply(protdf,2,FUN=function(x){
  sd(x)
})

cor_expr <- corVals

#which have high variance and low corr
df <- data.frame(feature = names(corVals), cval = corVals, vval = varVals[names(corVals)])
df <- df[order(df$cval),]
```

### percent positivity and sparsity

```{r, percent positivity in Hao et al}
ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))
ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]

#compute positivity matrix
mat <- obj@assays$RNA@counts[ref$gene,]

DefaultAssay(obj) <-'RNA'
dat <- FetchData(testobj, c(ref$gene,'celltype'))

positivity <- function(x){
  (sum(x>0)/length(x))*100
}

#for each celltype, fetch positivity of each gene
agg1 <- dat %>% group_by_('celltype') %>% 
          dplyr::summarise(across(ref$gene, positivity ))
agg1<-melt(agg1)

#now do same for median protein expression
DefaultAssay(testobj) <-'protein'
dat <- FetchData(testobj, c(ref$protein,'celltype'))

custom_median <- function(x){median(na.omit(x))}
agg2 <- dat %>% group_by_('celltype') %>% 
           dplyr::summarise(across(ref$protein, custom_median ))
agg2 <- melt(agg2)
df <- agg2


#need to account for fact that proteins can match to same gene

dfList <- list()
for(prot in ref$protein){
  gene <- ref$gene[match(prot,ref$protein)]
  subdf <- agg2[which(agg2$variable == prot),]
  subdf$rna <- agg1$value[match(paste0(subdf$celltype, gene), paste0(agg1$celltype, agg1$variable))]
  subdf$gene <- gene
  dfList[[prot]] <- subdf
}
df <- Reduce(rbind, dfList)

plotList <- list()
corVals <- list()
col <- paletteer::paletteer_d("rcartocolor::Geyser")[1]

for(prot in ref$protein){
  #strip Ab
  protname <- str_split(prot,'-')[[1]][1]
  subdf <- df[which(df$variable == prot),]
  corval <- cor(subdf$value, subdf$rna)
  corVals[[prot]] <- corval
  p <- ggplot(subdf, aes(y=value, x=rna, label= celltype))+
  geom_point(size=2.4, color = 'black', alpha=0.35, shape=21, fill=col )+
  geom_smooth(method = "lm", color='black', linewidth=0.5)+
  stat_cor(aes(label = after_stat(r.label)), size=6)+
  geom_text_repel(size=6, max.overlaps = 5)+
  theme_minimal()+
  #ggtitle('vs. standard deviation')+
  xlab(paste0(protname,' % +ve'))+
  ylab(paste0(protname,' (protein)'))+
    theme(plot.title = element_text(size=20),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size=15))+
    ggtitle(prot)
  plotList[[prot]] <- p

}
vs_pos <- plotList

corVals <- sort(unlist(corVals), decreasing = T)
cor_pos <- corVals
```


### pseudobulking

```{r}

ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))
ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]

DefaultAssay(obj) <-'protein'
dat1 <- FetchData(testobj, c(ref$protein,'celltype'))

custom_median <- function(x){median(na.omit(x))}
agg1 <- dat1 %>% group_by_('celltype') %>% 
           dplyr::summarise(across(ref$protein, custom_median ))
agg1 <- melt(agg1)
agg1$celltype <- str_replace_all(agg1$celltype,'_','-')


pseudo <- AggregateExpression(testobj, assays = "RNA", return.seurat = T, group.by = c("donor","celltype"))

dat2 <- FetchData(pseudo, c(ref$gene,'celltype','donor'))

agg2 <- dat2 %>% group_by_('celltype') %>% 
           dplyr::summarise(across(ref$gene, mean))
agg2 <- melt(agg2)

  

dfList <- list()
for(prot in ref$protein){
  print(prot)
  gene <- ref$gene[match(prot,ref$protein)]
  subdf <- agg1[which(agg1$variable == prot),]
  subdf$rna <- agg2$value[match(paste0(subdf$celltype, gene), paste0(agg2$celltype, agg2$variable))]
  subdf$gene <- gene
  dfList[[prot]] <- subdf
}
  
df <- Reduce(rbind, dfList)

plotList <- list()
corVals <- list()
col <- paletteer::paletteer_d("rcartocolor::Geyser")[1]

for(prot in ref$protein){
  #strip Ab
  protname <- str_split(prot,'-')[[1]][1]
  subdf <- df[which(df$variable == prot),]
  corval <- cor(subdf$value, subdf$rna)
  corVals[[prot]] <- corval
  p <- ggplot(subdf, aes(y=value, x=rna, label= celltype))+
  geom_point(size=2.4, color = 'black', alpha=0.35, shape=21, fill=col )+
  geom_smooth(method = "lm", color='black', linewidth=0.5)+
  stat_cor(aes(label = after_stat(r.label)), size=6)+
  geom_text_repel(size=6, max.overlaps = 5)+
  theme_minimal()+
  #ggtitle('vs. standard deviation')+
  xlab(paste0(protname,' pseudocount RNA'))+
  ylab(paste0(protname,' (protein)'))+
    theme(plot.title = element_text(size=20),
        axis.title.x = element_text(size=15),
        axis.title.y = element_text(size=15))+
    ggtitle(prot)
  plotList[[prot]] <- p

}
vs_pseudo <- plotList

corVals <- sort(unlist(corVals), decreasing = T)
cor_pseudo <- corVals

```



```{r, categorize and density plot}
df <- data.frame(protein = names(cor_expr), corval = cor_expr, corposval = cor_pos[names(cor_expr)], corpseudoval = cor_pseudo[names(cor_expr)], category = '')
df[is.na(df)] <- 0
df$category[which(df$corval < 0)] <- 'negative'
df$category[which(df$corval >= 0 & df$corval < 0.4)] <- 'weak'
df$category[which(df$corval >= 0.4 & df$corval <0.7)] <- 'moderate'
df$category[which(df$corval >= 0.7)] <- 'strong'
df$category <- factor(df$category, levels = c('negative','weak','moderate','strong'))

cols <- unname(method_cols[c(1,5,7,8)])
names(cols) <- c('negative','weak','moderate','strong')
p1 <- ggplot(df, aes(x = corval, fill=category))+
   geom_density(alpha=0.78)+
   theme_minimal()+
   scale_fill_manual(values=cols, name='')+
   xlab('')+
   ylab('')+
  scale_x_continuous(limits=c(-0.5,1))+
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.6, "lines"))+
  ggtitle('mRNA correlation')


p2 <- ggplot(df, aes(x = corposval, fill=category))+
   geom_density(alpha=0.78)+
   theme_minimal()+
   scale_fill_manual(values=cols, name='')+
   xlab('')+
   ylab('')+
   scale_x_continuous(limits=c(-0.5,1))+
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.6, "lines"))+
  ggtitle('% positivity correlation')


p3 <- ggplot(df, aes(x = corpseudoval, fill=category))+
   geom_density(alpha=0.78)+
   theme_minimal()+
   scale_fill_manual(values=cols, name='')+
   xlab('')+
   ylab('')+
   scale_x_continuous(limits=c(-0.5,1))+
  theme(legend.title = element_text(size = 10), 
        legend.text  = element_text(size = 10),
        legend.key.size = unit(0.6, "lines"))+
  ggtitle('pseudobulk correlation')

#do same but this time for correlations by % positivity

#add barplot to show number of features
df$dummy <- 'empty'
df$category <- factor(df$category, levels = rev(c('negative','weak','moderate','strong')))
p4 <- ggplot(df, aes( y=dummy, fill=category))+
  geom_bar(position="stack",stat='count')+
  geom_text(aes(label = after_stat(count)),stat = "count", size = 2.4, position = position_stack(vjust = 0.5), color= c('white','black','black','black'))+
  scale_fill_manual(values=rev(unname(method_cols[c(1,5,7,8)])), guide='none')+
  theme_void()+
  xlab('number of proteins')+
  theme(axis.title.x = element_text(size=8, vjust=-0.5),
        plot.margin = unit(c(0,0,1,0), "cm"))

p4 <- plot_grid(NULL, p4,NULL, ncol=3, rel_widths = c(0.1,0.61,0.29))
p<-plot_grid(p1,p2,p3,p4, ncol=1, rel_heights = c(0.295,0.295,0.295,0.115))

ggsave(p, file=paste0(outdir,'/Hao_RNA_proxy_density_categories.png'), width=375/100, height=615/100)
```



#FIG2:  Prediction Results

## FIG2A Heamap of predition correlation


```{r, metric heatmaps}
corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')


#cluster
mat <- as.data.frame(pivot_wider(cordf, names_from = c('feature'), values_from = 'value'))
rownames(mat) <- as.character(mat[,1])
mat <- mat[,-c(1)]

if(length(unique(colnames(mat))) > 1){
  checkmat <- t(mat)
  cleanvals <- names(which(colSums(as.matrix(!apply(checkmat,1, is.na))) <=2))
  dis <- dist(t(mat[,colnames(mat) %nin% cleanvals]))
  clu <- hclust(dis)
  cordf$feature <- factor(cordf$feature, levels = c(labels(as.dendrogram(clu)), cleanvals))
}

#set shape
cordf$shape_scale <- 'positive'
cordf$shape_scale[which(cordf$value <0)] <- 'negative'


#fetch correlation improvement compared to using RNA. Set missing to 1. since RNA isn't present.
ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))

ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]
DefaultAssay(obj) <-'protein'
protdf <- FetchData(obj, ref$protein)
DefaultAssay(obj) <-'RNA'
genedf <- FetchData(obj, ref$gene)
genedf <- genedf[,ref$gene]
cmat <- cor(protdf, genedf)
cvals <- diag(cmat)
names(cvals) <- rownames(cmat)



#facet into groups
cutset <- cut(1:length(levels(cordf$feature)),2)
names(cutset) <-levels(cordf$feature)
cordf$group <- cutset[cordf$feature]

#remove NA produced by SPECK
cordf <- cordf[!is.na(cordf$value),]

cordf$original <- cvals[as.character(cordf$feature)] 
cordf$improvement <- (cordf$value-  cordf$original)
cordf$improvement[which(is.na(cordf$improvement))] <- 1


#cordf$improvement <- scales::rescale(cordf$improvement, c(0.3,1), c(min(na.omit(cordf$improvement)),max(na.omit(cordf$improvement))))

#cordf$improvement <- sapply(cordf$improvement , FUN=function(x){ max(x, 0.6) })

p <- ggplot(cordf, aes(x = method, y = feature, fill = value))+
  geom_tile(color='black')+
  #geom_point(aes( size=improvement),shape=22, color='black',stroke = 0.3)+
  #scale_size(range=c(0.1,3.5), name= 'cor. improvement.')+
  scale_color_gradientn(colors=rev(geyser_adjust),limits = c(-1,1), name='cor.')+
  
  scale_fill_gradientn(colors=rev(geyser_adjust),limits = c(-1,1), name='cor.')+
  #ggtitle('Correlation Coefficient RNA ~ protein')+
  xlab('') + ylab('')+
  theme_minimal()+
  facet_wrap(vars(group), scales='free')+
  theme(plot.title = element_text(size=12),
        strip.text.x = element_blank(),
        axis.text.x = element_text(angle=90, vjust=0.5, hjust=1, size=13),
        axis.text.y = element_text(size=11),
        legend.title = element_text(size=12),
        legend.text = element_text(size=9),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      panel.background = element_blank())

ggsave(p4,  file=paste0(outdir,'/1_1_prediction_heatmap.png'), width=7, height=18)
```

## FIG 2B density of prediciton correlation by method

```{r, ggridges prediction density}


corrList <- benchmark_predset[['1']]$cor
cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')

#now plot RMSE
RMElist <- benchmark_predset[['1']]$RMSE
RMSEdf <- lapply(names(RMSEList), FUN=function(n){
  
  vals <- RMSEList[[n]]
  df <- data.frame(names(vals),vals, n)
  return(df)
  
})
RMSEdf <- Reduce(rbind, RMSEdf)
colnames(RMSEdf) <- c('feature','value','method')


#add matched rna measurement
rna_cor <- data.frame(feature = names(cor_expr), value=cor_expr, method='gene mRNA')
cordf <- rbind(cordf, rna_cor)

ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))

ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]
DefaultAssay(obj) <-'protein'
protdf <- FetchData(obj, ref$protein)
DefaultAssay(obj) <-'RNA'
genedf <- FetchData(obj, ref$gene)
genedf <- genedf[,ref$gene]

rna_RMSE <- c()
for(i in 1:dim(protdf)[2]){
  n <- colnames(prot)[i]
  protvals <- protdf[,i]
  genevals <- genedf[,i]
  diff <- protvals - genevals
  errorval <- sqrt(mean(diff )^2)
  rna_RMSE  <- c(rna_RMSE, errorval)
}
names(rna_RMSE) <- colnames(protdf)
rna_RMSE <- data.frame(feature = names(rna_RMSE), value=rna_RMSE, method='gene mRNA')
RMSEdf <- rbind(RMSEdf, rna_RMSE)

cordf$method <- factor(cordf$method, levels = c(rev(names(method_cols)), 'gene mRNA'))
p1 <- ggplot(cordf, aes(y=method,x=value, fill=method))+
 geom_density_ridges(quantile_lines = TRUE, quantiles = 2)+
  theme_minimal()+
  scale_fill_manual(values=c('gene mRNA' ='#b3b3b3', method_cols), guide='none')+
ggtitle('Pearson correlation')+
  xlab('')+
  ylab('')+
  theme(axis.text.y=element_text(size=15, vjust=-0.3),
        axis.text.x=element_text(size=13))



RMSEdf$method <- factor(RMSEdf$method, levels = c(rev(names(method_cols)), 'gene mRNA'))
#RMSEdf$value <- log(RMSEdf$value)
p2 <- ggplot(RMSEdf, aes(y=method,x=value, fill=method))+
 geom_density_ridges(quantile_lines = TRUE, quantiles = 2)+
  theme_minimal()+
  scale_fill_manual(values=c('gene mRNA' ='#b3b3b3', method_cols), guide='none')+
ggtitle('RMSE')+
  xlab('')+
  ylab('')+
  #scale_x_log10()+
  scale_x_continuous(limits = c(-0.5,4))+
  theme(axis.text.y=element_text(size=15, vjust=-0.3),
        axis.text.x=element_text(size=13))
  

p <- plot_grid(p1,p2, ncol=1)
ggsave(p,  file=paste0(outdir,'/prediction_performance_density.png'), width=4.5, height=6.8)

```



## FIG 2C scatter dependence on counts and variance

```{r, prediction influenced by data?}
#investigate best / worst performers
corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')

#plot receptor total expression and variability against avg predicted correlation
#for each receptor get everage prediction correlation
agg <- cordf %>% group_by(feature) %>% dplyr::summarize(meancor = mean(na.omit(value)))
agg <- agg[order(agg$meancor, decreasing = T),]
agg <- as.data.frame(agg)
rownames(agg) <- agg$feature
cor_pred <- agg

training_data <- read_csv(paste0(savedir,"benchmarking/training_files/1_1_training_data_prot_norm.csv"))
training_data <- as.data.frame(training_data)
rownames(training_data) <- training_data[,1]
training_data <- training_data[,-1]
meanvals <- apply(training_data,1,FUN=function(x){mean(x)})
varvals <- apply(training_data,1,FUN=function(x){var(x)})
sdvals <- apply(training_data,1,FUN=function(x){sd(x)})

#get total counts
training_data_raw <- read_csv(paste0(savedir,"benchmarking/training_files/1_1_training_data_prot_raw.csv"))
training_data_raw <- as.data.frame(training_data_raw)
rownames(training_data_raw) <- training_data_raw[,1]
training_data_raw <- training_data_raw[,-1]
totcounts <- apply(training_data_raw,1,FUN=function(x){sum(x)})


df <- data.frame(counts = meanvals, vars = varvals, totals = totcounts, sdvals = sdvals )

#save subtable
subdf <- df[,c('totals','sdvals')]
colnames(subdf) <- c('total_protein_counts','protein_standard_deviation')
write.csv(subdf, file=paste0(outdir, '/prot_counts_sd_table.csv'))

#agg<-agg[-229,]
agg <- cbind(agg, df[rownames(agg),])

col <- paletteer::paletteer_d("rcartocolor::Geyser")[1]

p1 <- ggplot(agg, aes(meancor, counts))+
  geom_point(size=1, color = 'black', alpha=0.55, shape=21, fill=col )+
  geom_smooth(method='glm', color='black', linewidth=0.5)+
  stat_cor(aes(label = after_stat(r.label)), size=6)+
  theme_minimal()+
  #ggtitle('vs. counts')+
 xlab('mean cor.') +
  ylab('total counts')+
  ggtitle('')+
  theme(plot.title = element_text(size=20),
        axis.title.x = element_text(size=13),
        axis.title.y = element_text(size=13))


p2 <- ggplot(agg, aes(meancor, sdvals))+
  geom_point(size=1, color = 'black', alpha=0.35, shape=21, fill=col )+
  geom_smooth(method = "glm", formula = y~x,
                      method.args = list(family = gaussian(link = 'log')), color='black', linewidth=0.5)+
  stat_cor(aes(label = after_stat(r.label)), size=6)+
  theme_minimal()+
  #ggtitle('vs. standard deviation')+
  xlab('mean cor.')+
  ylab('s.d.')+
  ggtitle('')+
    theme(plot.title = element_text(size=20),
        axis.title.x = element_text(size=13),
        axis.title.y = element_text(size=13))



p <- plot_grid(p1,p2, ncol=1)
ggsave(p,  file=paste0(outdir,'/prediction_dependence_on_signal.png'), width=2.5, height=5)
```



## SUPP FIG 2 Correlation by strategy

```{r}

corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')

#plot receptor total expression and variability against avg predicted correlation
#for each receptor get everage prediction correlation
agg <- cordf %>% group_by(feature) %>% dplyr::summarize(meancor = mean(na.omit(value)))
agg <- agg[order(agg$meancor, decreasing = T),]
agg <- as.data.frame(agg)
rownames(agg) <- agg$feature
cor_pred <- agg

#find receptors that fail both the above approximations
cor_metrics <- data.frame(expr = cor_expr, pos = cor_pos[names(cor_expr)], pseudo = cor_pseudo[names(cor_expr)], pred = cor_pred$meancor[match(names(cor_expr), cor_pred$feature)])

#save file
tab <- cor_metrics
colnames(tab) <- c('mRNA norm. expression','%positivity','pseudobulk','ML prediction')
write.csv(tab, file = paste0(outdir,'/predocor_table.csv'))

cor_metrics[is.na(cor_metrics)] <- 0

#of the ones that fail RNa based methods, how many are rescued by ML prediction
ind <-which(rowSums(cor_metrics[,c('expr','pos','pseudo')] < 0.7) == 3)

#create supplementary figure showing best methods of imputation for each protein
df <- cor_metrics
df$feature <- rownames(df)
df <- pivot_longer(df, cols=  colnames(df)[1:4])
remap <- c(expr = 'norm. RNA', pos = 'RNA positivity', pseudo = 'pseudobulk',pred= 'ML prediction')
df$name <- remap[df$name]
df$name <- factor(df$name, levels = remap)
#cluster
hc <- hclust(dist(cor_metrics))
dend <- as.dendrogram(hc)
df$feature <- factor(df$feature, levels=labels(dend))
df<- df[order(match(df$feature,labels(dend))),]
#group into multiple
cutset <- cut(1:length(labels(dend)),2)
names(cutset) <-labels(dend)
df$group <- cutset[df$feature]

p <- ggplot(df, aes(x = name, y=feature, fill=value))+
  geom_tile()+
  facet_wrap(vars(group), scales='free')+
  scale_fill_gradientn(colors=rev(geyser_adjust),limits = c(-1,1), name='pred. cor.')+
  theme(plot.title = element_text(size=12),
  strip.text.x = element_blank(),
  axis.text.x = element_text(angle=45, vjust=1, hjust=1),
  axis.text.y = element_text(size=8),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_blank(),
  panel.background = element_blank())+
  xlab('')+
  ylab('')

ggsave(p, file=paste0(outdir,'/correlation_by strategy_heatmap.png'), width=5, height=12)

```

## FIG 2D correlation improvement

```{r}

cor_metrics$exp_pred_diff <-   cor_metrics$pred - cor_metrics$expr

#bin into degrees of improvement
cor_metrics$improvement <- NA
ind <- which(cor_metrics$exp_pred_diff > -0.05 & cor_metrics$exp_pred_diff  < 0.05)
cor_metrics$improvement[ind] <- 'stable'
ind <- which(cor_metrics$exp_pred_diff >= 0.05 & cor_metrics$exp_pred_diff  < 0.25)
cor_metrics$improvement[ind] <- 'weak impr.'
ind <- which(cor_metrics$exp_pred_diff >= 0.25 & cor_metrics$exp_pred_diff  < 0.5)
cor_metrics$improvement[ind] <- 'moderate impr.'
ind <- which(cor_metrics$exp_pred_diff >= 0.5 & cor_metrics$exp_pred_diff  < 0.75)
cor_metrics$improvement[ind] <- 'strong impr.'
ind <- which(cor_metrics$exp_pred_diff >= 0.75 & cor_metrics$exp_pred_diff  < 1)
cor_metrics$improvement[ind] <- 'very strong impr.'

cor_metrics$improvement <- factor(cor_metrics$improvement,levels = c('stable','weak impr.', 'moderate impr.','strong impr.','very strong impr.'))

#or try as density plot?
p <- ggplot(cor_metrics,aes(x=exp_pred_diff))+
  geom_histogram(binwidth = 0.05, alpha=0.5,color="black", fill=paletteer::paletteer_d("rcartocolor::Geyser")[1])+
  geom_vline(xintercept = 0, color="black",  linetype="dashed", size=0.5)+
  theme_minimal()+
  scale_x_continuous( limits = c(-0.05,1))+
  ylab('feature count')+
  xlab('correlation improvement')

ggsave(p, file=paste0(outdir,'/correlation_improvement_histogram.png'), width=4, height=1.5)


```


```{r}

#find receptors that fail both the above approximations
cor_metrics <- data.frame(expr = cor_expr, pos = cor_pos[names(cor_expr)],  pseudo = cor_pseudo[names(cor_expr)], pred = cor_pred$meancor[match(names(cor_expr), cor_pred$feature)])
cor_metrics$feature <- rownames(cor_metrics)
df <- pivot_longer(cor_metrics, cols = colnames(cor_metrics)[-5])
remap = c(expr = 'norm. RNA', pos = 'RNA positivity', pseudo = 'pseudobulk',pred= 'ML prediction')
df$name <- remap[df$name]
df$name <- factor(df$name, levels = remap)
p <- ggplot(df, aes(y = value, x= name, fill=name))+
  geom_violin(draw_quantiles = 0.5)+
  scale_fill_manual(values= unname(method_cols[c(1,3,4,7)]), name = 'prediction method')+
  theme_minimal()+
  geom_hline(yintercept = 0, linetype='dashed')+
  xlab('')+
  ylab('pred. cor.')+
  theme(axis.text.y=element_text(size=10),
        axis.title.y = element_text(size=11),
      axis.text.x=element_text(size=11, angle=20, hjust=1, vjust=1),
      legend.position = 'none')

ggsave(p, file=paste0(outdir,'/prediction_strategy_comparison.png'), width=4, height=2.2)
```


## FIG 2E platelet marker


```{r}
ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))
ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]
DefaultAssay(testobj) <-'protein'
protdf <- FetchData(testobj, ref$protein)
DefaultAssay(testobj) <-'RNA'
genedf <- FetchData(testobj, unique(ref$gene))



posvals <- apply(genedf, 2, FUN=function(x){
  sum(x>0)/length(x)
}) %>% sort()

#seek low positivity RNA whose protein has strong prediction correlation 
corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')

#plot receptor total expression and variability against avg predicted correlation
#for each receptor get everage prediction correlation
agg <- cordf %>% group_by(feature) %>% dplyr::summarize(meancor = median(na.omit(value)))
agg <- agg[order(agg$meancor, decreasing = T),]
agg <- as.data.frame(agg)
rownames(agg) <- agg$feature
cor_pred <- agg

targetgene <- ref$gene[match(cor_pred$feature, ref$protein)]
cor_pred$pos <- posvals[targetgene]
df <- cor_pred[!is.na(cor_pred$pos),]
df$predrank <-rank(df$meancor)
df$posrank <- rank(-df$pos)
df <- df[order(df$predrank + df$posrank, decreasing = T),]
df$gene <- ref$gene[match(df$feature, ref$protein)]
#add prediction values to object


#for the top 5, plot RNA vs prot vs prediction
plotList <- lapply(1:5, FUN=function(i){
  print(i)
  subdf <- df[i,,drop=F]
  predvals <- benchmark_predset[['1']]$pred$scLinear[subdf$feature,]
  testobj@meta.data[,paste0('scLinear_',subdf$feature)] <- predvals
  p <- FeaturePlot(testobj, c(subdf$gene, subdf$feature, paste0('scLinear_',subdf$feature)), order=T)
})
names(plotList) <- df$feature[1:5]

#lets focus in on MPL/CD110, interesting platelet angle
predvals <- benchmark_predset[['1']]$pred$scLinear['CD110-Ab',]
testobj@meta.data[,paste0('scLinear_CD110-Ab')] <- predvals
testobj$platelet  <- NA
testobj$platelet[which(testobj$celltype == 'Platelet')]  <- 'Platelets'
p1 <- DimPlot(testobj, group.by='platelet',repel=T, label=F, raster=F) +
scale_color_manual(values = paletteer::paletteer_d("rcartocolor::Geyser")[c(7)], na.value =  paletteer::paletteer_d("rcartocolor::Geyser")[1])+
  ggtitle('')+
  theme(legend.position='none',
        axis.title = element_blank(),
        axis.text = element_text(size=7),
        text = element_text(size =10),
        plot.margin = margin( 0,2,0,0, "cm"))
p2 <- FeaturePlot(testobj,'MPL', order=T) +  scale_color_gradientn(colors= colorRampPalette(paletteer::paletteer_c("grDevices::Purple-Yellow",100))(100)[1]) + 
  ggtitle('MPL (RNA)') + 
  theme(  axis.title = element_blank(), 
          axis.text = element_text(size=10))
p3 <- FeaturePlot(testobj,'CD110-Ab', order=T) +  scale_color_gradientn(colors= colorRampPalette(paletteer::paletteer_c("grDevices::Purple-Yellow",100))(100))+ 
  ggtitle('CD110 (protein)')+ 
  theme(  axis.title = element_blank(),
          axis.text = element_text(size=10))
p4 <- FeaturePlot(testobj,'scLinear_CD110-Ab', order=T) +  scale_color_gradientn(colors= colorRampPalette(paletteer::paletteer_c("grDevices::Purple-Yellow",100))(100))+ 
  ggtitle('CD110 (scLinear)')+ 
    theme(  axis.title = element_blank(),
          axis.text = element_text(size=10))

p <- plot_grid(p1,p2,p3,p4)

ggsave(p, file=paste0(outdir,'/Platelets_CD110_UMAP.png'), width=7.5, height=7)
```




## FIG 2F scatter of RNA vs ML

```{r}
corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')

#plot receptor total expression and variability against avg predicted correlation
#for each receptor get everage prediction correlation
agg <- cordf %>% group_by(feature) %>% dplyr::summarize(meancor = mean(na.omit(value)))
agg <- agg[order(agg$meancor, decreasing = T),]
agg <- as.data.frame(agg)
rownames(agg) <- agg$feature
cor_pred <- agg

df<- data.frame(expr = cor_expr, pred = cor_pred$meancor[match(names(cor_expr), cor_pred$feature)])
#replace NA values with zeros
df[is.na(df)] <- 0
df$gene <- ref$gene[match(rownames(df), ref$protein)]
df$protein <- rownames(df)
df$protein <- lapply(df$protein, FUN=function(x){str_split(x,'-')[[1]][1]}) %>% unlist()
df$diff <- df$pred - df$expr
df <- df[order(df$diff, decreasing=T),]
df$label <- NA
#highlight some features
targets <- c('CD45RA','CD45RO','CD45RB','CD109','CD103','CD110')
df$label[match(targets, df$protein)] <- df$protein[match(targets, df$protein)]

#categories
df$category <- NA
df$category[which(df$expr < 0)] <- 'negative'
df$category[which(df$expr >= 0 & df$expr < 0.4)] <- 'weak'
df$category[which(df$expr >= 0.4 & df$expr <0.7)] <- 'moderate'
df$category[which(df$expr >= 0.7)] <- 'strong'
df$category <- factor(df$category, levels = c('negative','weak','moderate','strong'))



p <- ggplot(df, aes(x=expr, y=pred, label=label, fill = category, color=category))+
  geom_point(size=1, alpha=0.75, shape=21)+
  scale_fill_manual(values=unname(method_cols[c(1,5,7,8)]), name='mRNA\ncor. category\n')+
  scale_color_manual(values=darken(unname(method_cols[c(1,5,7,8)]),0.5), guide=F)+
  theme_minimal()+
  geom_label_repel(color='black', size=4.2, force=3,  fill = alpha(c("white"),0.4))+
  geom_abline(intercept = 0, slope = 1, color="black", 
                 linetype="dashed", size=1)+
  ylim(c(min(df[,c(1,2)]), max(df[,c(1,2)])))+
  ylab('mean ML pred. cor.')+
  xlab('gene mRNA pred. cor.')+
  guides(fill = guide_legend(override.aes = list(size=5)))+
  theme(legend.text = element_text(size=15),
        legend.title = element_text(size=17),
        axis.title = element_text(size=15))

ggsave(p, file=paste0(outdir,'/RNA_vs_pred_scatter.png'), width=5.5, height=3.5)
```

## FIG 2G scatter of RNA vs ML split by celltype

```{r}

#for each celltype, get the rna cor and the mean ml pred cor
ref <- read.csv(paste0(savedir,'repo/source_data/protein_gene_symbol_map.csv'))
ref <- ref[which(!is.na(ref$gene)),]
ref <- ref[which(ref$gene %in% rownames(obj[['RNA']])),]
DefaultAssay(testobj) <-'protein'
protdf <- FetchData(testobj, ref$protein)
DefaultAssay(testobj) <-'RNA'
genedf <- FetchData(testobj, ref$gene)
genedf <- genedf[,ref$gene]
cmat <- cor(protdf, genedf)
cvals <- diag(cmat)
names(cvals) <- rownames(cmat)

#plot
df <- data.frame(features  = names(cvals), correlation = cvals)
df <- melt(df)
df$gene <- ref$gene[match(df$features, ref$protein)]
df$features<-factor(df$features, levels= rev(df$features[order(df$value)]))
df <-  df[match(levels(df$features), df$features),]


categories <- c("NK","DC","Mono",  "CD8 T" ,  "CD4 T" , "B")



dfList <- list()
for(n in names(benchmark_predset[['1']][['pred']])){
  pred <- benchmark_predset[['1']][['pred']][[n]][ref$protein,, drop=F]
  colnames(pred) <- colnames(testobj)
  
  for(ct in categories){
    print(ct)
    cells <- colnames(testobj)[which(testobj$general_celltype==ct)]
    predmat <- pred[,cells]
    protmat <- testobj[['protein']]@data[ref$protein,cells] %>% as.matrix()
    rnamat <- testobj[['RNA']]@data[ref$gene,cells] %>% as.matrix()
    
    cvals1 <- cor(t(predmat), t(protmat)) %>% diag()
    names(cvals1) <- rownames(predmat)
    
    cvals2 <- cor(t(rnamat), t(protmat)) %>% diag()
    names(cvals2) <- rownames(predmat)
    
    #now get average expression in the celltype of interest
    medvals <- apply(protmat,1,FUN=function(x){median(x)})
    
    df <- data.frame(pred_prot=cvals1,rna_prot=cvals2, celltype=ct, method = n ,medexpr = medvals, feature = names(cvals1))
    dfList[[paste0(ct,'_',n)]] <- df  
  }
  
}
df <- Reduce(rbind,dfList)

agg <- df %>% group_by(celltype, feature) %>% dplyr::summarize(meanpred = mean(pred_prot), rna_prot = mean(rna_prot), medexpr = mean(medexpr))
agg$label <- NA
agg$celltype <- factor(agg$celltype, levels = c('NK','CD4 T','CD8 T','B','Mono','DC'))
p <- ggplot(agg, aes(x = rna_prot, y= meanpred, label=label, color=medexpr))+
    geom_point(size=0.75, alpha=0.75)+
  scale_color_viridis_c(name = 'median\nnorm. expr.')+
  theme_minimal()+
  geom_label_repel(color='black', size=4.2, force=3,  fill = alpha(c("white"),0.4))+
  geom_abline(intercept = 0, slope = 1, color="black", 
                 linetype="dashed", size=0.5)+
  facet_wrap(vars(celltype))+
  ylab('mean ML pred. cor.')+
  xlab('gene mRNA pred. cor.')+
  theme(legend.key.width = unit(0.25, "inches"),
        strip.text = element_text(size=13))

ggsave(p, file=paste0(outdir,'/RNA_vs_pred_scatter_celltype_expression.png'), width=6, height=3.5)
```




#FIG3: PRED DEPENDS ON CT

## FIG 3A Scatter plot by cell type

```{r, show why base is good}
#plot to show broad organisation of cell types

#for each feature, do prediction vs reality, coloured by cell type
testing_data <- read_csv(paste0(savedir,"benchmarking/testing_files/1_1_testing_data_prot_raw.csv"))
testcells <- colnames(testing_data)
testobj <- subset(obj, cells=testcells)


markers <- rownames(obj[['protein']])
categories <- c("NK","DC","Mono",  "CD8 T" ,  "CD4 T" , "B")
predList <- benchmark_predset[['1']]$pred

preds <- lapply( 'scMMT', FUN=function(n){
  print(n)
  dat <- FetchData(testobj, c('general_celltype') ,assay = n)
  
  preds <- predList[[n]]
  rownames(preds) <- paste0(n,'-',rownames(preds))
  dat <- cbind(dat, t(preds))
  colnames(dat) <- str_remove_all( colnames(dat),paste0(n,'-'))
  

  dat[,markers] <- apply(dat[,markers],2, FUN=function(x){
    if(min(x) <0){
      x <- x - min(x)
    }
    x/max(x)
    })
  dat <- dat[which(dat$general_celltype %in% categories),c('general_celltype',markers)]
 
  dat$method <- n

  dat$cellID <- rownames(dat)
  
  return(dat)
})


preds <-Reduce(rbind, preds) 
preds<-melt(preds)

dat <- FetchData(testobj, c('general_celltype',markers) ,assay = 'protein')
dat <- dat[which(dat$general_celltype %in% categories),]
dat$method <-'true'
colnames(dat) <- str_remove_all( colnames(dat),paste0(tolower('protein'),'_'))
dat$cellID <- rownames(dat)
dat <- melt(dat)

#normalise true values to 1
dat$value <- dat$value / max(dat$value)

#match up true expression with predictions
true_cells <- paste0(dat$cellID,'_',dat$variable)
pred_cells <-paste0(preds$cellID,'_',preds$variable)
preds$true_expression <- dat$value[match(pred_cells,true_cells)]



plotList <- list()
feats <- c('CD2-Ab', "CD3-1-Ab" ,"CD8a-Ab", "CD14-Ab" )
for(feat in feats){
  subpred <- preds[which(preds$variable == feat),]
  
  p1 <-   p <- ggplot(subpred, aes(x=true_expression, y = value, color = general_celltype))+
 # geom_point(size=0.1, alpha=0.1)+
  #geom_density_2d(bins=10)+
  geom_point(size=1.1, alpha=0.5)+
  #geom_smooth(method='lm', inherit.aes=F ,aes(y=true_expression, x = value) )+
  theme_minimal()+
  scale_color_manual(values  = ct_cols  )+
  guides(color = guide_legend(override.aes = list(size=5, alpha=1)), name='none')+
      geom_smooth(method='lm', inherit.aes=F ,aes(x=true_expression, y = value) )+
  stat_cor(color='black', aes(label = after_stat(r.label)), size=8)+
  xlab('measured expression')+
  ylab('predicted expression (scMMT)')+
  geom_hline(aes(yintercept=-Inf)) + 
  geom_vline(aes(xintercept=-Inf)) + 
  coord_cartesian(clip="off")+
  theme(axis.text = element_text(size=7),
        legend.position='none')+
  ggtitle(feat)
  
  p2 <- ggplot(subpred, aes(x=true_expression, y = value))+
  # geom_point(size=0.1, alpha=0.1)+
  #geom_density_2d(bins=10)+
  rasterize(geom_point(size=0.1, alpha=0.5,aes(color = general_celltype)))+
  geom_smooth(method='lm', inherit.aes=F ,aes(x=true_expression, y = value) )+
  stat_cor(color='black',aes(label = after_stat(r.label)), size=5)+
  theme_minimal()+
  scale_color_manual(values  = ct_cols , name='' )+
  guides(color = guide_legend(override.aes = list(size=5, alpha=1)))+
  xlab('measured expression')+
  ylab('predicted expression (scMMT)')+
  geom_hline(aes(yintercept=-Inf)) + 
  geom_vline(aes(xintercept=-Inf)) + 
  coord_cartesian(clip="off")+
  theme(axis.text = element_text(size=7))+
  facet_wrap( variable ~ general_celltype, ncol=3) +
    ggtitle('')+
    theme(strip.background = element_blank(),
    strip.text.x = element_blank())
  
  
  p <- plot_grid(p1,p2, rel_widths = c(0.5,0.8))
  plotList[[feat]] <- p
}

p <- plot_grid(plotlist=plotList ,ncol=1)
ggsave(p,  file=paste0(outdir,'/example_corr_scatter.png'), width=7.5, height=12)

```



## FIG 3C Linea plots of variations

```{r, all methods in one plot}


#first do barplot of median correlation acheived for each method
corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')
agg <- cordf %>% group_by(method) %>% dplyr::summarize(medval = median(na.omit(value)))

agg$method <- factor(agg$method, levels= names(method_cols))
p1<- ggplot(agg, aes(x=method, y=medval, fill=method))+
  geom_chicklet(stat='identity')+
  scale_fill_manual(values=method_cols, name='')+
  theme_minimal()+
  ylab('')+
  xlab('')+
  theme(legend.position='none',
        legend.text = element_text(size=12),
      axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=1),
      axis.text.y = element_text(size=12), 
      plot.title = element_text(size=15))+
  ggtitle('Overall Median Correlation')

#get the correlation of full data predictions, per cell type
cts_cat <- c("NK",  "CD4 T", "CD8 T" ,"B","Mono",   "DC")


predset <- benchmark_predset[['1']]$pred
testing_data <- as.data.frame(read.csv(paste0(savedir,"benchmarking/testing_files/1_1_testing_data_prot_norm.csv", row.names=1)))
meta <- as.data.frame(read.csv(paste0(savedir,"benchmarking/training_files/1_1_metadata.csv")))
rownames(meta) <- meta[,1]
meta <- meta[colnames(testing_data),]
cts<-meta$general_celltype

#FETCH ALL
dfList <- list()
for(i in names(predset)){
  pred <- predset[[i]]
  print(i)
  dfs <- lapply(cts_cat, FUN=function(cat){
    print(cat)
    subpred <- pred[,which(meta$general_celltype == cat)]
    subreal <- testing_data[,which(meta$general_celltype == cat)]
    cval <- cor(t(subpred), t(subreal), method = 'pearson')
    cval <- diag(cval)
    df <- data.frame(value = median(na.omit(cval)), celltype = cat, method = i, type='All' )
    return(df)
  })
  df <- Reduce(rbind,dfs)
  dfList[[i]] <- df
}

all_df <- Reduce(rbind, dfList)
all_df$method <- factor(all_df$method, levels= names(method_cols))
all_df$celltype <- factor(all_df$celltype, levels = cts_cat)
scale_max <- 0.65

#try line plot?
p2 <- ggplot(all_df, aes(y=value, color=method, x=celltype, group=method))+
  geom_point(size=3.5)+
  geom_line(size=1.2)+
  scale_color_manual(values=method_cols, name='')+
  scale_y_continuous(limits=c(-0.05,scale_max))+
  theme_minimal()+
  # geom_label_repel(aes(label = label),
  #                 direction='y',
  #                 na.rm = TRUE)+
  ylab('median cor.')+
  xlab('')+
  theme(legend.position='none',
        legend.text = element_text(size=12),
        axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=1),
        axis.text.y = element_text(size=12),
        plot.title = element_text(size=15))+
  ggtitle('All Cell Types')


p2
#FETCH one-type-only
predset <- one_only_predset
corrSet <- list()
for(i in names(predset)){
  corrList <- predset[[i]][['cor']]
  
  cordf <- lapply(names(corrList), FUN=function(n){
  
    rvals <- corrList[[n]]
    df <- data.frame(names(rvals),rvals, n)
    return(df)
    
  })
  cordf <- Reduce(rbind, cordf)
  colnames(cordf) <- c('feature','value','method')

  agg <- cordf %>% group_by(method) %>% dplyr::summarise(meanval = mean(na.omit(value)), varval = var(na.omit(value)), value = median(na.omit(value)))
  agg$partition <- i
  corrSet[[as.character(i)]] <- agg
}

oo_df <- Reduce(rbind, corrSet)
oo_df$method <- factor(oo_df$method, levels= names(method_cols))
oo_df$partition <- factor(oo_df$partition, levels = cts_cat)

p3 <- ggplot(oo_df, aes(y=value, color=method, x=partition, group=method))+
  geom_point(size=3.5)+
  geom_line(size=1.2)+
  scale_color_manual(values=method_cols, name='')+
    scale_y_continuous(limits=c(-0.05,scale_max))+
  theme_minimal()+
  # geom_label_repel(aes(label = label),
  #                 direction='y',
  #                 na.rm = TRUE)+
  ylab('median cor.')+
  xlab('')+
  theme(legend.position='none',
        legend.text = element_text(size=12),
       axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=1),
        axis.text.y = element_text(size=12),
       plot.title = element_text(size=15))+
  ggtitle('Within Cell Type')


#FETCH Leave-one-out
predset <- leave_out_predset
corrSet <- list()
for(i in names(predset)){
  corrList <- predset[[i]][['cor']]
  
  cordf <- lapply(names(corrList), FUN=function(n){
  
    rvals <- corrList[[n]]
    df <- data.frame(names(rvals),rvals, n)
    return(df)
    
  })
  cordf <- Reduce(rbind, cordf)
  colnames(cordf) <- c('feature','value','method')

  agg <- cordf %>% group_by(method) %>% dplyr::summarise(meanval = mean(na.omit(value)), varval = var(na.omit(value)), value = median(na.omit(value)))
  agg$partition <- i
  corrSet[[as.character(i)]] <- agg
}

loo_df <- Reduce(rbind, corrSet)
#rename parition for plotting
newnames <- c('_B'='B','_CD4 T'='CD4 T','_CD8 T'='CD8 T','_DC'='DC','_Mono'='Mono','_NK'='NK')
loo_df$partition <- newnames[loo_df$partition]
loo_df$method <- factor(loo_df$method, levels= names(method_cols))
loo_df$partition <- factor(loo_df$partition, levels = cts_cat)

p4 <- ggplot(loo_df, aes(y=value, color=method, x=partition, group=method))+
  geom_point(size=3.5)+
  geom_line(size=1.2)+
  scale_color_manual(values=method_cols, name='')+
    scale_y_continuous(limits=c(-0.05,scale_max))+
  theme_minimal()+
  # geom_label_repel(aes(label = label),
  #                 direction='y',
  #                 na.rm = TRUE)+
  ylab('median cor.')+
  xlab('')+
  theme(legend.text = element_text(size=12),
              axis.text.x = element_text(size=15, angle=45, hjust=1, vjust=1),
        axis.text.y = element_text(size=12),
        plot.title = element_text(size=15))+
  ggtitle('Held-out Cell Type')




p <- plot_grid(p1,p2,p3,p4, ncol=4, rel_widths = c(0.2,0.23,0.23,0.3))
ggsave(p,  file=paste0(outdir,'/variations_line_plots.png'), width=16, height=4)
```




## FIG 3D scLinear feature importance

```{r}
#fetch files
file <- list.files(paste0(savedir,'/benchmarking/method_predictions/scLinear/') ,pattern = '1_1_sclinear_model_feature', full.names = T)
imp <- read.csv(file, header = T, row.names = 1)

library(fgsea)

#fead in gmt files 
gmtfiles <- sort(list.files('./gmt_files/',full.names=T))
names(gmtfiles) <- c('REACTOME','CANON_PATH','GO_BP','GO_CC','GO_MF','IMMUNESIG','CELLTYPE','HALLMARK')

DBs <- lapply(gmtfiles, FUN=function(filename){
  gs <- gmtPathways(filename)
})
names(DBs) <- names(gmtfiles)

#function to add names to a vector and run gsea (to enable use of apply)
runfg <- function(vals,nm,gs){
  vals <- as.numeric(vals)
  names(vals) <- nm
  gse <- fgsea(pathways = gs, stats = vals)
  return(gse)
}

library(pbapply)
#for each database collect fgsea results
fgseaResList <- lapply(names(DBs), FUN=function(n){
  print(n)
  genesets <- DBs[[n]]
  
  gseall <- suppressWarnings(pbapply(imp,1,runfg,nm=colnames(imp), gs=genesets))
  comb <- bind_rows(gseall,.id = "Protein")
  comb$DB <- n
  return(comb)
})

names(fgseaResList) <- names(DBs)
save(fgseaResList, file =  paste0(outdir,'/scLinear_FGSEA_results.Rdata'))

resdf <- Reduce(rbind, fgseaResList)
topn <- lapply(unique(resdf$DB), FUN=function(n){
  res <- resdf[which(resdf$DB == n),]
  res <- res[res$padj < 0.05,]
  toppath <- res %>% arrange(Protein,desc(abs(NES))) %>% group_by(Protein) %>% select(Protein,pathway,NES) %>% top_n(10) %>% ungroup %>% pull(pathway) %>% unique
  
  #if more than 100 pathways, restirct to those that are significant in highest number of features
  if(length(toppath)>100){
    subres <- res[which(res$pathway %in% toppath & res$padj < 0.05),]
    toppath <- table(subres$pathway) %>% sort(decreasing = T) 
    toppath <- names(toppath)[1:100]
  }
  return(toppath)
})
names(topn) <- names(DBs)


#color protein names by whether mean prediction correlation is > 0.5
corrList <- benchmark_predset[['1']]$cor

cordf <- lapply(names(corrList), FUN=function(n){
  
  rvals <- corrList[[n]]
  df <- data.frame(names(rvals),rvals, n)
  return(df)
  
})
cordf <- Reduce(rbind, cordf)
colnames(cordf) <- c('feature','value','method')

#plot receptor total expression and variability against avg predicted correlation
#for each receptor get everage prediction correlation
agg <- cordf %>% group_by(feature) %>% dplyr::summarize(meancor = mean(na.omit(value)))
agg <- agg[order(agg$meancor, decreasing = T),]
agg <- as.data.frame(agg)
rownames(agg) <- agg$feature
cor_pred <- agg
cor_pred$color <- 'red'
cor_pred$color[which(cor_pred$meancor > 0.5)] <- 'black'


plotList <- lapply(names(fgseaResList), FUN=function(DBname){

  scores <- fgseaResList[[DBname]]
  #make a wide table to cluster from
  w <- scores %>% filter(pathway%in%topn[[DBname]]) %>% select(Protein,pathway,NES) %>% pivot_wider(names_from = "Protein",values_from = "NES")
  wdf <- data.frame(w[,-1],check.names = F)
  rownames(wdf) <- pull(w,1)
  
  hc <- hclust(dist(wdf))
  hct <- hclust(dist(t(wdf)))

  scores <- scores %>% filter(pathway%in%topn[[DBname]]) %>%
  mutate(pathway=factor(.$pathway,levels=hc$labels[hc$order]),
         Protein=factor(.$Protein,levels=hct$labels[hct$order])) %>%
  mutate(NES=ifelse(.$pval<0.05,.$NES,NA))
  
  colvec <- cor_pred$color[match(as.character(scores$Protein), cor_pred$feature)]
  p <-   ggplot(scores, aes(x=Protein,y=pathway,fill=NES))+geom_tile()+
  scale_x_discrete(guide=guide_axis(angle = 90))+
  scale_fill_gradient2(high="red",mid="white",low="blue",midpoint = 0,na.value = "lightgrey")+
    theme(axis.text.x = element_text(color = colvec))

  # cols <- paletteer::paletteer_d('rcartocolor::Geyser')[1:4]
  # p <- ggplot(scores, aes(x = term, y =feature, fill=ES))+
  #   geom_tile()+
  #   theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
  #         strip.text.x = element_blank())+
  #   facet_wrap(vars(group), scales='free')+
  #   scale_fill_gradientn(colors=rev(cols), name = 'ES score')
  return(p)

})
names(plotList) <- names(fgseaResList)

#save to plots
for(n in names(plotList)){
  p <- plotList[[n]]
  ggsave(p, file = paste0(outdir,'/',n,'_ES_heatmap.png'), height=15, width=40)
}

#now do smaller plot os key markers
markers <- c("CD3-1-Ab", "CD3-2-Ab",  "CD4-1-Ab",  "CD4-2-Ab", "CD8-Ab", "CD8a-Ab", "CD19-Ab",  "CD14-Ab", "CD16-Ab","CD103-Ab","CD110-Ab"  )


plotList <- lapply(names(fgseaResList), FUN=function(DBname){

  scores <- fgseaResList[[DBname]]
  scores <- scores[scores$Protein %in% markers,]
  #make a wide table to cluster from
  w <- scores %>% filter(pathway%in%topn[[DBname]]) %>% select(Protein,pathway,NES) %>% pivot_wider(names_from = "Protein",values_from = "NES")
  wdf <- data.frame(w[,-1],check.names = F)
  rownames(wdf) <- pull(w,1)
  
  hc <- hclust(dist(wdf))
  hct <- hclust(dist(t(wdf)))

  scores <- scores %>% filter(pathway%in%topn[[DBname]]) %>%
  mutate(pathway=factor(.$pathway,levels=hc$labels[hc$order]),
         Protein=factor(.$Protein,levels=hct$labels[hct$order])) %>%
  mutate(NES=ifelse(.$pval<0.05,.$NES,NA))
  
  colvec <- cor_pred$color[match(as.character(scores$Protein), cor_pred$feature)]
  p <-   ggplot(scores, aes(x=Protein,y=pathway,fill=NES))+geom_tile()+
  scale_x_discrete(guide=guide_axis(angle = 90))+
  scale_fill_gradient2(high="red",mid="white",low="blue",midpoint = 0,na.value = "lightgrey")+
    theme(axis.text.x = element_text(color = colvec))

  # cols <- paletteer::paletteer_d('rcartocolor::Geyser')[1:4]
  # p <- ggplot(scores, aes(x = term, y =feature, fill=ES))+
  #   geom_tile()+
  #   theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1),
  #         strip.text.x = element_blank())+
  #   facet_wrap(vars(group), scales='free')+
  #   scale_fill_gradientn(colors=rev(cols), name = 'ES score')
  return(p)

})
names(plotList) <- names(fgseaResList)

for(n in names(plotList)){
  p <- plotList[[n]]
  ggsave(p, file = paste0(outdir,'/',n,'_ES_heatmap_justmarkers.png'), height=15, width=15)
}


#try a different approahc. For each protein, fetch 10 most important genes
topgenes <- lapply(rownames(imp), FUN=function(n){
  x <- t(imp[n,]) %>% as.data.frame()
  out <- rownames(top_n(x,10))
}) 
names(topgenes) <- rownames(imp)

targetgenes <- topgenes[markers]%>% unlist() %>% unique()
submat <- as.data.frame(imp[markers,targetgenes ])
hc <- hclust(dist(1-cor(submat)))
hcprot <- hclust(dist(1-cor(t(submat))))

submat$protein <- rownames(submat)
df <- pivot_longer(submat, cols = targetgenes )
df$protein <- factor(df$protein, levels = rev(hcprot$labels))
df$name <- factor(df$name, levels = hc$labels)

p <- ggplot(df, aes(y=protein, x =name, fill=value))+
  geom_tile()+
  scale_x_discrete(guide=guide_axis(angle = 90))+
  scale_fill_gradient2(high=paletteer::paletteer_d("rcartocolor::Geyser")[7],mid="white",low=paletteer::paletteer_d("rcartocolor::Geyser")[1],midpoint = 0, name='importance',na.value = "lightgrey", oob = squish, limits = c(-0.2, 0.2))+
  theme_minimal()+
  xlab('')+
  ylab('')


ggsave(p, file = paste0(outdir,'/top_importance_genes.png'), height=3, width=13)

#now plot expression of the topgenes, are they discrimintating relevant cell types?
training_data <- read_csv(paste0(savedir,"benchmarking/training_files/1_1_training_data_rna_norm.csv"))
training_data  <- as.data.frame(training_data )  
rownames(training_data ) <- training_data [,1]
training_data  <- training_data[,-1]

targetgenes <- topgenes[markers]%>% unlist() %>% unique()
targetgenes  <- str_replace(targetgenes  ,'HLA\\.','HLA-')
targetgenes  <- str_replace(targetgenes  ,'MT\\.','MT-')
mat <- training_data[targetgenes ,] 
df <- mat %>% t() %>% as.data.frame()
df$celltype <- obj@meta.data[rownames(df), 'general_celltype']

df <- pivot_longer(df, cols=targetgenes)
agg <- df %>% group_by(celltype, name) %>% summarise(meanval =mean(value))

agg$name <- factor(agg$name, levels = str_replace(hc$labels,'\\.','-'))
agg$celltype <- factor(agg$celltype, levels = rev(c('other T', 'CD4 T','CD8 T', 'NK', 'B','Mono','DC','other')) )
cols <- paletteer::paletteer_d("rcartocolor::Geyser")[4:7]

p <- ggplot(agg, aes(y=celltype,x=name,  fill=meanval))+
  geom_tile()+
  scale_fill_viridis_c(name = 'mean norm. expr.')+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5))+
  xlab('')+
  ylab('')

ggsave(p, file = paste0(outdir,'/top_importance_gene_expression.png'),  height=3, width=13)
```


# FIG4: Dataset-Dataset Comparison


```{r}

datacomp_list <- load(paste0(savedir, '/dataset_comparison/compiled_outcomes.Rdata')) %>% get()
shared_abs <- read.csv(paste0(savedir,'/repo/source_data/dataset_comparison_shared_antibodies.csv'))
shared_abs<-shared_abs[which(shared_abs$shared),]

#unpack mean correlation
corrSets <- list()
for(n in unique(names(datacomp_list))){
  set <- datacomp_list[[n]][['correlation']]
  medvals <- lapply(set, FUN=function(x){median(na.omit(x[shared_abs$Hao_etal]))})
  df <- unlist(medvals) %>% data.frame()
  df['comp',] <- n
  df<- t(df)
  corrSets[[n]] <- df
}
cordf <- Reduce(rbind, corrSets) %>% as.data.frame()

trainsets <- lapply(cordf$comp, FUN=function(x){str_split(x,'_vs_')[[1]][1]}) %>% unlist()
testsets <- lapply(cordf$comp, FUN=function(x){str_split(x,'_vs_')[[1]][2]}) %>% unlist()
cordf$train <-trainsets
cordf$test <- testsets
cordf$comp <- NULL

cor_longdf <- pivot_longer(cordf,cols =colnames(cordf)[1:8], names_to='method')
cor_longdf$value <-as.numeric(cor_longdf$value)


#assign tissue to column
cor_longdf$train_tissue <- NA
cor_longdf$train_tissue[which(cor_longdf$train %in% c( "Hao_etal","Stephenson_etal_Covid","Stephenson_etal_Healthy" ))] <-'PBMC'
cor_longdf$train_tissue[which(cor_longdf$train %in% c( "Leader_etal"))] <-'Lung'
cor_longdf$train_tissue[which(cor_longdf$train %in% c( "Zhang_etal"))] <-'Synovium'
cor_longdf$test_tissue <- NA
cor_longdf$test_tissue[which(cor_longdf$test %in% c( "Hao_etal","Stephenson_etal_Covid","Stephenson_etal_Healthy" ))] <-'PBMC'
cor_longdf$test_tissue[which(cor_longdf$test %in% c( "Leader_etal"))] <-'Lung'
cor_longdf$test_tissue[which(cor_longdf$test %in% c( "Zhang_etal"))] <-'Synovium'

ind <- match(cor_longdf$train_tissue,c("PBMC","Lung","Synovium") )
cor_longdf$train <- factor(cor_longdf$train, levels = unique(cor_longdf$train[order(ind)]))

ind <- match(cor_longdf$test_tissue,c("PBMC","Lung","Synovium") )
cor_longdf$test <- factor(cor_longdf$test, levels = rev(unique(cor_longdf$test[order(ind)])))

#collect resource usage by comparison and method
traces <- read.csv(paste0(savedir,'dataset_comparison/dataset_comparison_resource_and_runtime_metrics.csv'))

trainsets <- lapply(traces$comparison, FUN=function(x){str_split(x,'_vs_')[[1]][1]}) %>% unlist()
testsets <- lapply(traces$comparison, FUN=function(x){str_split(x,'_vs_')[[1]][2]}) %>% unlist()

traces$train <-trainsets
traces$test <- testsets
traces$comparison <- NULL


#convert memory to bytes
convert_to_bytes <- function(mem_str) {
  # Remove any leading/trailing spaces
  mem_str <- trimws(mem_str)
  
  # Extract the numeric part. This uses a regular expression to keep the digits and decimals.
  value <- as.numeric(sub("([0-9.]+).*", "\\1", mem_str))
  
  # Extract the unit by removing the numeric component.
  # trimws() is used to get rid of any extra spaces.
  unit <- toupper(trimws(sub("[0-9.]+", "", mem_str)))
  
  # Determine the multiplier based on the unit.
  multiplier <- switch(unit,
                       "B"  = 1,
                       "KB" = 1024,
                       "MB" = 1024^2,
                       "GB" = 1024^3,
                       "TB" = 1024^4,
                       stop("Unknown unit: ", unit))
  
  # Return the value in bytes.
  value * multiplier
}
traces$peak_vmem[which(traces$peak_vmem == '0')] <- '0 B'
bytes <- lapply(traces$peak_vmem, FUN=function(x){
    print(x)
    convert_to_bytes(x)
}) %>% unlist()

traces$peak_vmem_bytes <- bytes


#convert time to seconds

# Extract the minutes part: capture any digits at the start of the string before "m".

convert_to_seconds <- function(duration) {
  h <- as.numeric(str_extract(duration, "\\d+(?=h)"))
  m <- as.numeric(str_extract(duration, "\\d+(?=m)"))
  s <- as.numeric(str_extract(duration, "\\d+(\\.?\\d*)?(?=s)"))
  
  h[is.na(h)] <- 0
  m[is.na(m)] <- 0
  s[is.na(s)] <- 0
  
  total_seconds <- h * 3600 + m * 60 + s
  return(total_seconds)
}

seconds <- convert_to_seconds(traces$realtime)
minutes <- seconds/60
traces$realtime  <- minutes

traces$X.cpu.num <-str_remove(traces$X.cpu,'%')
traces$X.cpu.num <- as.numeric(traces$X.cpu.num)

```

## SUPP FIG 3 Grid of dataset-dataset comparisons

```{r, grid of comparisons correlation}

tissues <- c('PBMC','Lung','Synovium')
tissue_cols <- unname(c(method_cols[c(7,2)], darken(method_cols[4], 0.2)))
names(tissue_cols) <- tissues

cor_longdf$x.label <- paste0("<span style = 'color: ", tissue_cols[cor_longdf$test_tissue], ";'>", cor_longdf$test, "</span>")
cor_longdf$y.label <- paste0("<span style = 'color: ", tissue_cols[cor_longdf$train_tissue], ";'>", cor_longdf$train, "</span>")



#heatmap or corr, worted by tissue
p1 <- ggplot(cor_longdf, aes(x =x.label, y = reorder(y.label, desc(y.label)), fill = value, label = round(value,2) ))+
  geom_tile(color='black')+
  geom_text(size=3)+
  scale_fill_gradientn(colors=rev(geyser_adjust),limits = c(-max(cor_longdf$value), max(cor_longdf$value)),name = 'mean\npred.\ncorr.')+
  facet_wrap(vars(method), ncol=2)+
  theme_minimal()+
  theme(axis.text.x = element_markdown(angle=60, vjust=1, hjust=1), 
        axis.text.y = element_markdown())+
  xlab('test')+ ylab('train')+
  scale_y_discrete()

ggsave(p1, file = paste0(outdir,'dataset-dataset-prediciton_correlation.png'), width=7, height=10)


```





## FIG 4B Boxplots of prediction comparisons

```{R}

#categorize
cor_longdf$cat <- NA
cor_longdf$cat[which(cor_longdf$train == cor_longdf$test)] <- 'within dataset'
cor_longdf$cat[which(cor_longdf$train != cor_longdf$test & cor_longdf$train_tissue == cor_longdf$test_tissue)] <- 'between dataset, within tissue'
cor_longdf$cat[which(cor_longdf$train != cor_longdf$test & cor_longdf$train_tissue != cor_longdf$test_tissue)] <- 'between dataset, between tissue'

cor_longdf$cat <- factor(cor_longdf$cat, levels = c('within dataset', 'between dataset, within tissue', 'between dataset, between tissue' ))

p <- ggplot(cor_longdf, aes(x = cat, y = value))+
  geom_boxplot(width=0.5, outlier.alpha = 0, fill = lighten(geyser_adjust[1],0.75), color = darken(geyser_adjust[1],0.3), lwd=0.5)+
  geom_point(size=0.5, alpha=0.5)+
  theme_minimal()+
  facet_wrap(vars(method), ncol=2)+
  xlab('')+ylab('mean pred. corr.')+
   geom_pwc(p.adjust.method="bonferroni", method = "wilcox.test",label='p.adj.signif', step.increase = 0.3,hide.ns = TRUE)+
  theme(axis.text.x = element_text(angle=45,hjust=1, vjust=1),
        plot.margin = unit(c(1,0,0,1.5),'cm'))+ ylim(c(0,1.7))


ggsave(p, file = paste0(outdir,'boxplots_dataset-dataset_comparisons.png'), width=4, height=9)

```



## FIG 4C Violin of Hao vs. Zhang Seurat pred. corr.

```{r, example markers}
shared_feat <- names(datacomp_list$Hao_etal_vs_Hao_etal$correlation$Seurat)
full_panelref <- read.csv(paste0(savedir,'repo/source_data/dataset_comparison_shared_antibodies.csv'))
panelref <-full_panelref[which(full_panelref$shared),]


test_prot_norm<- Zhang_test[['protein']]@data
ind1 <- which(panelref[,'Zhang_etal'] %in% rownames(test_prot_norm))
test_prot_norm <- test_prot_norm[panelref[ind1,'Zhang_etal'],]
#rename feat
rownames(test_prot_norm) <- panelref[ind1,'Hao_etal']

test_Zhang <- CreateSeuratObject(data = test_prot_norm, counts= test_prot_norm)

for(n in names(datacomp_list$Hao_etal_vs_Zhang_etal$predictions)){
  pred_syn <- datacomp_list$Hao_etal_vs_Zhang_etal$predictions[[n]]
  newmeta <- t(pred_syn)
  colnames(newmeta) <- paste0('Hao_',n,'-', colnames(newmeta))
  test_Zhang@meta.data <- cbind(test_Zhang@meta.data, newmeta)
  
  pred_syn <- datacomp_list$Zhang_etal_vs_Zhang_etal$predictions[[n]]
  ind <- match(rownames(pred_syn), panelref$Zhang_etal)
  rownames(pred_syn)[which(!is.na(ind))] <- panelref$Hao_etal[na.omit(ind)] 
  newmeta <- t(pred_syn)
  colnames(newmeta) <- paste0('Zhang_',n,'-', colnames(newmeta))
  test_Zhang@meta.data <- cbind(test_Zhang@meta.data, newmeta)
}

test_Zhang$unified_celltype <- Zhang_test$unified_celltype


#for each cell type compute overall prediction correlation
corrList <- list()
for(ct in na.omit(unique(Zhang_test$unified_celltype))){
  for(n in names(datacomp_list$Hao_etal_vs_Hao_etal$correlation)){
    
    print(n)
    pred_syn <- datacomp_list$Hao_etal_vs_Zhang_etal$predictions[[n]]
    ind <- which(test_Zhang$unified_celltype == ct)
    sub <- subset(test_Zhang, cells = ind)
  
    #for each antibody only compute correlation if the protein was actually measured on those cells
    corVals <- lapply(shared_feat, FUN=function(feat){
      print(feat)
      
      if(paste0('Hao_',n,'-',feat) %in% colnames(sub@meta.data)){
        dat <- FetchData(sub, c(feat, paste0('Hao_',n,'-',feat),paste0('Zhang_',n,'-',feat)))
        ind <- which(dat[,feat] != 0)
        corVal1 <- cor(dat[ind, feat], dat[ind,paste0('Hao_',n,'-',feat) ] , method = 'pearson')
        corVal2 <- cor(dat[ind, feat], dat[ind,paste0('Zhang_',n,'-',feat) ] , method = 'pearson')
        out <- data_frame(value = c(corVal1,corVal2), train = c('Hao vs. Zhang','Zhang vs. Zhang'))
        out$feat <- feat
        out$method <-n
        out$celltype <- ct
        return(out)
      }else{
        return(NA)
      }
      

    }) 
    out <- Reduce(rbind, corVals)
  
    corrList[[length(corrList)+1]] <- out 
  }

}

complete_correlations <- Reduce(rbind, corrList)
df <- complete_correlations

#categorize by where it's present in the Hao data
df$category <- df$celltype  %in% Hao_test$unified_celltype
#new plotting attempt

df <- df[which(!is.na(df$train)),]
df$celltype <- factor(df$celltype, levels = c('CD4 T','CD8 T','T','B','NK','DC','Mono','Mac','Fibro','Endo'))

ctcols <- unname(method_cols[c(2,7)])
check <- unique(df[,c('celltype','category')])
ctcols <- ctcols[as.numeric(check$category) + 1]
names(ctcols) <- check$celltype

subdf <- df[df$train == 'Hao vs. Zhang',]
p <- ggplot(subdf, aes(x=celltype, y=value, fill=category))+
    geom_violin( lwd=0.35, width=0.6)+
    geom_hline(yintercept = 0,  linetype='dotted')+
    #geom_text()+
    #geom_point()+
    facet_grid(cols= vars(train))+
    scale_fill_manual(values = unname(method_cols[c(2,7)]), name = 'cell type\nin Hao data')+
    theme_minimal()+
    theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1))+
    xlab('')+ ylab('prediction correlation')

ggsave(p, file = paste0(outdir,'overall_Seurat_prediction_violin_Hao_vs_Zhang.png'), width=7, height=2.3)

```

## FIG 4D Heatmap of Hao vs. Zhang Seurat Ab pred. corr.

```{R}

df <- complete_correlations[complete_correlations$train %in% c('Hao vs. Zhang'),]
df<-df[!is.na(df$celltype),]
df$celltype <- factor(df$celltype, levels = c('CD4 T','CD8 T','T','B','NK','DC','Mono','Mac','Fibro','Endo'))


df$y.label <- paste0("<span style = 'color: ", ctcols[as.character(df$celltype)], ";'>", df$celltype, "</span>")
df <- df[df$method == 'Seurat',]
p <- ggplot(df, aes(x = feat, y =reorder(y.label, desc(y.label)), fill = value))+
  geom_tile()+
  facet_wrap(vars(train), nrow=3)+
  theme_classic()+
  scale_fill_gradientn(colors = geyser_adjust, limits = c(-1,1), name = 'pred. corr.', na.value  = 'light grey')+
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=0.5),
        axis.text.y = element_markdown())+
  xlab('') + ylab('')

ggsave(p, file = paste0(outdir,'allAbs_Seurat_heatmap_Hao_vs_Zhang.png'), width=6, height=3)


```




## SUPP FIG 5 Leader et al data

```{R problem antibodies}

feat <- c('ADT-CD3','ADT-CD4','ADT-CD8','ADT-CD16','ADT-CD19')
Idents(Leader_test) <- factor(Leader_test$celltype_detailed, levels = unique(Leader_test$celltype_detailed[order(Leader_test$unified_celltype)]))

p <- VlnPlot(Leader_test, feat, group.by='celltype_detailed', pt.size=0, stack=T, flip=T) + scale_fill_manual(values = unname(method_cols)) +   theme(legend.position ='none', 
        axis.text.x = element_text(size=10),
        plot.margin = unit(c(0,0,0,2),'cm'))+ xlab('')

ggsave(p, file = paste0(outdir,'Leader_etal_show_quality_issues.png'), width=10, height=7)

```


```{R cd19 recovery}

Leader_test@meta.data[,'CD19_prediction'] <- t(datacomp_list$Hao_etal_vs_Leader_etal$predictions$Seurat['CD19-Ab',])

Leader_test@meta.data[,'CD19_protein'] <- Leader_test[['protein']]@data['ADT-CD19',]
Leader_test@meta.data[,'CD19_RNA'] <- Leader_test[['RNA']]@data['CD19',]

p<-VlnPlot(Leader_test, group.by='celltype_detailed', c('CD19_RNA','CD19_protein','CD19_prediction'), pt.size = 0, flip= T, stack=T) + 
  theme(legend.position ='none', 
        axis.text.x = element_text(size=10),
        plot.margin = unit(c(0,0,0,2),'cm'))+
  scale_fill_manual(values = rep(geyser_adjust[1],3)) + xlab('')

ggsave(p, file = paste0(outdir,'Leader_etal_CD19_prediction.png'), width=15,height=8)

```



## FIG 4E Method usability table


```{r}
library(readxl)
library(ggh4x)
library(ggforestplot)
library(ggnewscale)

usability <- read_excel(paste0('./usability_rating/Supplementary_Table_2_method_usability.xlsx'))


#repackage
usability_reduced <- usability %>% as.data.frame()
usability_reduced[1,1] <- 'Methods'
colnames(usability_reduced) <- usability_reduced[1,]
usability_reduced <- usability_reduced[-1,] %>% as.data.frame()
usability_reduced[,-1] <- t(apply(usability_reduced[,-1] , 1, FUN=as.numeric))

# #add rank based just on performance metrics
# meanrank <- apply(usability_reduced[,c('RAM usage','runtime','within dataset pred. corr.','between dataset pred. corr.')] ,1, FUN=function(x){mean(as.numeric(x))})
#usability_reduced[,'performance rank'] <- rank(-meanrank)

df <- pivot_longer(usability_reduced,cols = colnames(usability_reduced)[-1])
df$category <- colnames(usability)[match(df$name, usability[1,])]

df$category <- sapply(df$category, FUN=function(x){
 str_split(x,'\\.\\.\\.')[[1]][1]
})


category_colors <- c(
  "Software" = unname(method_cols[2]),
  "Tutorial" = unname(method_cols[4]),
  "Publication" = unname(method_cols[5]),
  "Performance" = unname(method_cols[7]) 
)
category_colors <- lighten(category_colors,0.5)

df$category <- factor(df$category, levels = c('Software','Tutorial','Publication','Performance'))
df$value <- as.numeric(df$value)

df$label <- NA

df$name <- factor(df$name, levels=  colnames(usability_reduced))
df$shape <- 22
df$shape[df$value < 1] <- 22


#assign alternating background fill colors
df <- df %>%
  group_by(name) %>%
  arrange(value) %>%   # you could order by any meaningful statistic
  mutate(
    study = factor(Methods, levels = rev(Methods)),  # reverse order
    row   = row_number()  # numeric row index within the facet
  ) %>%
  ungroup()

df_bg <- df %>%
  mutate(
    band = ifelse(row %% 2 == 0, "white", "white"),
    ymin = row - 0.5,
    ymax = row + 0.5
  )

#set the rang eof point size
sizerange <- c(0.2,7)

sizevalues <- df$value
sizevalues[which(is.na(sizevalues))] <- 1

p <- ggplot(df, aes(x = name , y = Methods, size = value, fill=value, color=value, shape = shape,label=label)) +
  geom_rect(
    data = df_bg,
    aes(
      xmin = -Inf,
      xmax = Inf,
      ymin = ymin,
      ymax = ymax
    ),
    fill = df_bg$band,
    alpha = 0.5,
    # set some transparency if desired
    inherit.aes = FALSE
  ) +
  scale_shape_identity() +
  scale_size(range= sizerange, name='')+
  scale_fill_gradientn(colors = paletteer::paletteer_d('rcartocolor::Geyser')[1:4] , guide="none", na.value = 'white')+
  scale_color_gradientn(colors =paletteer::paletteer_d('rcartocolor::Geyser')[1:4] , guide="none", na.value = 'white')+
  #scale_fill_identity() +
  geom_point(
    aes(color = value),
    stroke=3
  ) +
 new_scale_color()+
  geom_point(
    aes(color=value),
    stroke=1,
    size =scales::rescale(sizevalues, sizerange, range(sizevalues)) + 3.7
  ) +
    #geom_text(color='black',show.legend = FALSE)+
   guides(size = guide_legend(override.aes = list(shape = 22, stroke=0,size =seq(sizerange[1] +3.7, sizerange[2]+3.7, length.out=5),  colour = '#d9e1c8', fill = '#d9e1c8') ))+
  scale_color_gradientn(colors = darken(str_remove(paletteer::paletteer_d('rcartocolor::Geyser')[1:4], 'FF'),0.25), guide="none" , na.value = 'white')+
  facet_grid2(
    . ~ category,
    scale = 'free_x',
    space = 'free',
    # Here we specify the themed strip for the x-axis facets
    strip = strip_themed(background_x = elem_list_rect(fill = category_colors))
  ) +
  theme_minimal() +
 # guides(size = guide_legend(title = "", theme(legend.key.height =  unit(1.8,"line"))),override.aes = list(pch=21) )+
  theme(
    axis.text.x =  element_text(
      angle = 45,
      hjust = 1,
      vjust = 1,
      size=12
    ),
    axis.text.y = element_text(size=14),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    strip.background = element_rect(colour=NA),
    strip.text = element_text(size=12),
    plot.margin = unit(c(1,1,0,3), "cm")

  ) +
  xlab('') + ylab('')
  

ggsave(p, file = paste0(outdir,'usability_table.png'), width=12, height=6.5)

```




## SUPP FIG 4A Benchmarking performance over ascending fractions


```{r, mean corr by method}

#for each partition, get mean corr by method
predset <- benchmark_predset
corrSet <- list()
for(i in names(predset)){
  corrList <- predset[[i]][['cor']]
  
  cordf <- lapply(names(corrList), FUN=function(n){
  
    rvals <- corrList[[n]]
    df <- data.frame(names(rvals),rvals, n)
    return(df)
    
  })
  cordf <- Reduce(rbind, cordf)
  colnames(cordf) <- c('feature','value','method')

  agg <- cordf %>% group_by(method) %>% dplyr::summarise(meanval = mean(na.omit(value)), varval = var(na.omit(value)), medval = median(na.omit(value)))
  agg$partition <- i
  corrSet[[as.character(i)]] <- agg
}

df <- Reduce(rbind, corrSet)



labs1 <- as.character(rev(unique(df$partition)))
labs2 <- round(rev(unique(as.numeric(df$partition)))  * 0.8 * 161764)

df$partition <- as.character(df$partition)


#add labels to last entry
df$label <- NA
df$label[which(df$partition=='1')] <- as.character(df$method[which(df$partition=='1')])

df$perc <- paste0(100*as.numeric(df$partition) , '%')
df$perc <- factor(df$perc, levels =unique(df$perc[order(df$partition)]) )
df$method <- factor(df$method, levels = names(method_cols))

#try line plot?
p1 <- ggplot(df, aes(y=medval, color=method, x=perc, group=method))+
  geom_point(size=3.5)+
  geom_line(size=1.2)+
  scale_color_manual(values=method_cols, name='')+
  theme_minimal()+
  # geom_label_repel(aes(label = label),
  #                 direction='y',
  #                 na.rm = TRUE)+
  ylab('median cor.')+
  xlab('')+
  ggtitle('Pearson correlation')+
  theme(legend.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
         axis.title = element_text(size=14))


#now do RMSE

#now plot RMSE
RMSESet <- list()
for(i in names(predset)){
  RMSEList <- predset[[i]][['RMSE']]
  
  RMSEdf <- lapply(names(RMSEList), FUN=function(n){
  
    rvals <- RMSEList[[n]]
    df <- data.frame(names(rvals),rvals, n)
    return(df)
    
  })
  RMSEdf <- Reduce(rbind, RMSEdf)
  colnames(RMSEdf) <- c('feature','value','method')

  agg <- RMSEdf %>% group_by(method) %>% dplyr::summarise(meanval = mean(na.omit(value)), varval = var(na.omit(value)), medval = median(na.omit(value)))
  agg$partition <- i
  RMSESet[[as.character(i)]] <- agg
}

df <- Reduce(rbind, RMSESet)


labs1 <- as.character(rev(unique(df$partition)))
labs2 <- round(rev(unique(as.numeric(df$partition)))  * 0.8 * 161764)

df$partition <- as.character(df$partition)


#add labels to last entry
df$label <- NA
df$label[which(df$partition=='1')] <- as.character(df$method[which(df$partition=='1')])

df$perc <- paste0(100*as.numeric(df$partition) , '%')
df$perc <- factor(df$perc, levels =unique(df$perc[order(df$partition)]) )

df$method <- factor(df$method,  levels = names(method_cols))
#try line plot?
p2 <- ggplot(df, aes(y=medval, color=method, x=perc, group=method))+
  geom_point(size=3.5)+
  geom_line(size=1.2)+
  scale_color_manual(values=method_cols, name='')+
  theme_minimal()+
  # geom_label_repel(aes(label = label),
  #                 direction='y',
  #                 na.rm = TRUE)+
  ylab('median RMSE')+
  xlab('')+
  ggtitle('RMSE')+
  theme(legend.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title = element_text(size=14))

p <- plot_grid(p1,p2)

ggsave(p,  file=paste0(outdir,'/benchmarking_lineplot.png'), width=9.5, height=3.5)
```


## SUPP FIG 4B

```{R, RUNTIME METRICS}
duration <- read.csv(paste0(savedir,'repo/final_outputs/benchmarking_runtime_min.csv'), row.names = 1)
duration$cat <- 'runtime (minutes)'
perc_cpu <- read.csv(paste0(savedir,'/benchmarking/benchmarking_perc_cpu.csv'))
perc_cpu$cat <-'%cpu'
raw_cpu <- read.csv(paste0(savedir,'benchmarking/benchmarking_raw_cpu.csv'))
raw_cpu$cat <-'total cpu'
perc_ram <- read.csv(paste0(savedir,'benchmarking/benchmarking_perc_ram.csv'))
perc_ram$cat <- '%RAM'
raw_ram <- read.csv(paste0(savedir,'benchmarking/benchmarking_raw_ram.csv'))
raw_ram$cat <- 'total RAM'

keep <- c("scMMT" , "SPECK" ,"BABEL", "sciPENN" , "cTPnet" , "totalVI" ,"scLinear" , "Seurat")

dataSets <- list(duration = duration, perc_cpu=perc_cpu, raw_cpu=raw_cpu, perc_ram=perc_ram, raw_ram=raw_ram)
data <- Reduce(rbind, dataSets)
data <- data[,c(keep,'cat')]
data <- pivot_longer(data, cols=keep)
data$name <- as.character(data$name)
data$name[which(data$name=='cTPnet')] <-'cTP_net'
data$name <- factor(data$name, levels =names(method_cols))

data$cat <- factor(data$cat, levels= c('total RAM', '%RAM','total cpu','%cpu','runtime (minutes)'  ))

#remove duplicated rows
data <- data[!duplicated(data),]
p <- ggplot(data[which(data$cat %in% c('total RAM','%cpu','runtime (minutes)'  )), ], aes(x=name, y=value, fill = name, color=name))+
  geom_boxplot(outlier.size = 0, color=alpha('black',0.5))+
  geom_point(size=1.5, color = 'black', alpha=1, shape=21,)+
  scale_fill_manual(values=  method_cols, name='')+
  scale_color_manual(values=  method_cols, name='')+
  theme_minimal()+
  ggforce::facet_row(facets = vars(cat), 
                   scales = "free_y") +
 ylab('')+
 xlab('')+
 theme(axis.text.x = element_text(angle=45, hjust=1,vjust=1, size=11),
       legend.text = element_text(size=13),
       strip.text.x = element_text(size=14))
ggsave(p,  file=paste0(outdir,'/runtime_cpu_RAM.png'), width=10, height=3.3)



#plot duration over increments
duration$partition <- rownames(duration)
df <- melt(duration[,c('partition',keep)])

ggplot(df, aes(x=partition, y=value, group=variable, color=variable))+
  geom_point(size=3.5)+
  geom_line(size=1.2)+
  scale_color_manual(values=method_cols, name='')+
  theme_minimal()+
  # geom_label_repel(aes(label = label),
  #                 direction='y',
  #                 na.rm = TRUE)+
  ylab('median RMSE')+
  xlab('')+
  theme(legend.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12))

```



## SUPP FIG 6 Dataset composition

```{r}

df <- lapply(names(trainobjs), FUN=function(n){
  obj <- trainobjs[[n]]
  dat <- FetchData(obj,'unified_celltype')
  dat$dataset <- n
  return(dat)
})

df <- Reduce(rbind,df)
agg <- df %>% group_by(unified_celltype,dataset) %>% dplyr::summarise(n=n())


agg <- agg[agg$unified_celltype %nin% c('non-immune','T'),]
#clean generic high level annotation that aren't at same granularity as others
agg$unified_celltype <- factor(agg$unified_celltype, levels = c('B','T','CD4 T','CD8 T','NK','NKT','ILC','DC','Mono','Mac','Platelets','RBC','HSPC','Granulocyte','Endo','Fibro'))

cols <- colorRampPalette(method_cols)(length(levels(agg$unified_celltype)))
p <- ggplot(agg, aes(x = dataset, y= unified_celltype, size= n, fill=unified_celltype ))+
  geom_point(pch=21, color='black')+
  theme_minimal()+
  scale_size(name='# of cells')+
  scale_fill_manual(values =cols , guide='none')+
  theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1))+
  ylab('')+xlab('')


ggsave(p, file = paste0(outdir,'dataset_composition_summary.png'), width=4, height=5, dpi=600)
```





